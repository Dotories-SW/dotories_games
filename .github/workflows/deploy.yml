name: Deploy dotories_games (self-hosted)

on:
  push:
    branches:
      - master          # master에 push될 때 자동 배포
  workflow_dispatch:    # 필요하면 Actions에서 수동 실행도 가능
    inputs:
      ref:
        description: 'Git ref to deploy (optional)'
        required: false
        default: 'master'

jobs:
  deploy:
    runs-on: self-hosted   # ✅ 서버 A의 runner에서 실행

    steps:
      - name: Deploy on SERVER A (local)
        run: |
          echo "===== Deploy on SERVER A (local) ====="
          cd /home/ubuntu/dotories_games

          echo "[A] git sync"
          git fetch --all
          git reset --hard origin/master

          echo "[A] install deps"
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi

          echo "[A] build"
          npm run build
          # 만약 next export 쓰면:
          # npm run export

          echo "[A] restart pm2"
          if command -v pm2 >/dev/null 2>&1; then
            pm2 describe dotories_games >/dev/null 2>&1 && \
              pm2 restart dotories_games || \
              pm2 start "npx serve out -l 3000" --name dotories_games
            pm2 save
          else
            echo "[A] ERROR: pm2 not found"
            exit 1
          fi

      - name: Deploy on SERVER B (via SSH)
        run: |
          echo "===== Deploy on SERVER B ====="

          SERVER_B=ubuntu@210.109.15.236

          ssh -o StrictHostKeyChecking=no $SERVER_B "
            set -e
            cd /home/ubuntu/dotories_games

            echo '[B] git sync'
            git fetch --all
            git reset --hard origin/master

            echo '[B] install deps'
            if [ -f package-lock.json ]; then
              npm ci || npm install
            else
              npm install
            fi

            echo '[B] build'
            npm run build
            # npm run export   # 필요하면 주석 해제

            echo '[B] restart pm2'
            if command -v pm2 >/dev/null 2>&1; then
              pm2 describe dotories_games >/dev/null 2>&1 && \
                pm2 restart dotories_games || \
                pm2 start \"npx serve out -l 3000\" --name dotories_games
              pm2 save
            else
              echo '[B] ERROR: pm2 not found'
              exit 1
            fi

            echo '===== SERVER B deploy done ====='
          "
